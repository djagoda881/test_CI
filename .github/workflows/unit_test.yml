name: Test action

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest
    
    env:
      PROJECT_PATH: tests/dbt_projects/postgres
      GITHUB_USERNAME: ${{ secrets.USERNAME }}
      GITHUB_TOKEN: ${{ secrets.TOKEN }}
      EMAIL: ${{ secrets.EMAIL2 }}

    services:
      postgres:
        image: postgres:15.1
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: db
        ports:
          - 5432:5432

    steps:
      - name: Set Git config
        run: |
          git config --global credential.helper store
          git config --global user.email $EMAIL
          git config --global user.name $GITHUB_USERNAME
          git config --global core.askpass ""
          git config --global core.sshCommand "ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no"
          git config --global credential.helper 'store --file ~/.my-credentials'
        
      - uses: actions/checkout@v3
        with:
          persist-credentials: true
          repository: dyvenia/prefect-viadot
          token: $GITHUB_TOKEN
          ref: main
          
      - name: Set up Python 3.10
        uses: actions/setup-python@v2
        with:
          python-version: "3.10"
          
      - name: Install dependencies
        run: |
          pip install .[test]
          
      - name: Setting up the test environment
        run: |
          
          # Replacing the hostname in given files. This is necessary because in the CI action the postgres database is on "localhost" not in "nesso_postgres".
          sed -i 's/nesso_postgres/localhost/g' tests/conftest.py
          sed -i 's/nesso_postgres/localhost/g' $PROJECT_PATH/profiles.yml

          # Copying the necessary folders to the dbt project and installing dbt deps
          cp -R macros/ $PROJECT_PATH
          cd $PROJECT_PATH && dbt deps
        
        shell: bash

      - name: Run pytest
        run: |
          # Running all tests in a postgres project
          cd $PROJECT_PATH && pytest ../../test_*.py
